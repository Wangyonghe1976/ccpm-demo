---
id: https://github.com/Wangyonghe1976/ccpm-demo/issues/9
title: Markdown Editor Integration (Cherry Markdown)
epic: ai-assistant-note-integration
status: pending
priority: high
parallel: false
created: 2025-09-06T02:30:00Z
updated: 2025-09-06T17:33:25Z
dependencies: [001, 002, 003, 004, 005, 006, 007]
---

## Description
Integrate Cherry Markdown editor for markdown-based note editing with live preview and AI assistant integration.

## Acceptance Criteria
- [ ] Cherry Markdown editor integrated
- [ ] Live preview functionality
- [ ] Markdown-specific formatting support
- [ ] Syntax highlighting for code blocks
- [ ] Table editing support
- [ ] Math formula support (LaTeX)
- [ ] Diagram support (Mermaid, Flowchart)
- [ ] Custom toolbar for markdown shortcuts
- [ ] Export to HTML/PDF functionality
- [ ] Theme integration with application
- [ ] Mobile-responsive editor
- [ ] AI-powered markdown assistance

## Implementation Details

### Cherry Markdown Integration
```typescript
// Markdown editor component
interface MarkdownEditorProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  readOnly?: boolean;
  preview?: boolean; // Show live preview
  theme?: 'default' | 'dark' | 'auto';
}

// Editor configuration
const cherryConfig = {
  id: 'markdown-editor',
  engine: {
    global: {
      classicBr: false,
      urlEncode: true,
      htmlWhiteList: '',
      htmlFilter: true
    },
    syntax: {
      codeBlock: {
        theme: 'dark',
        wrap: true,
        lineNumber: true
      },
      table: {
        enable: true,
        toolbar: true
      },
      list: {
        enable: true
      },
      header: {
        enable: true,
        level: [1, 2, 3, 4, 5, 6]
      },
      math: {
        engine: 'mathjax',
        src: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
        enable: true
      },
      mermaid: {
        enable: true,
        theme: 'default'
      },
      flowchart: {
        enable: true
      }
    }
  },
  toolbars: {
    toolbar: [
      'bold', 'italic', 'strikethrough', '|',
      'color', 'background', '|',
      'header', '|',
      'list', 'checklist', '|',
      'code', 'formula', 'mermaid', 'flowchart', '|',
      'link', 'image', 'video', '|',
      'table', '|',
      'undo', 'redo', '|',
      'settings'
    ],
    bubble: ['bold', 'italic', 'underline', 'strikethrough', 'sub', 'sup', 'quote', '|', 'size', 'color'],
    float: ['h1', 'h2', 'h3', 'h4', 'quote', '|', 'code', 'formula', 'mermaid', 'flowchart']
  },
  preview: {
    enable: true,
    mode: 'split', // 'edit', 'preview', 'split'
    theme: 'default',
    actions: ['export', 'copy', 'theme']
  }
};
```

### Live Preview Implementation
```typescript
// Live preview component with synchronized scrolling
interface LivePreviewProps {
  markdown: string;
  className?: string;
  syncScroll?: boolean;
  onScrollSync?: (ratio: number) => void;
}

// Preview synchronization
const usePreviewSync = (editor: any, preview: any) => {
  useEffect(() => {
    const syncScroll = (event: any) => {
      const editorScroll = event.target.scrollTop;
      const editorHeight = event.target.scrollHeight - event.target.clientHeight;
      const ratio = editorScroll / editorHeight;
      
      const previewScroll = ratio * (preview.scrollHeight - preview.clientHeight);
      preview.scrollTop = previewScroll;
    };
    
    editor.addEventListener('scroll', syncScroll);
    return () => editor.removeEventListener('scroll', syncScroll);
  }, [editor, preview]);
};
```

### AI Assistant Integration for Markdown
```typescript
// Markdown-specific AI operations
interface MarkdownAIOperations {
  // Generate markdown table from data
  generateTable: (headers: string[], rows: any[][]) => string;
  
  // Format code blocks with syntax highlighting
  formatCodeBlock: (code: string, language: string) => string;
  
  // Generate documentation from code
  generateDocComments: (code: string, language: string) => string;
  
  // Convert between formats
  htmlToMarkdown: (html: string) => string;
  markdownToHtml: (markdown: string) => string;
  
  // Lint and fix markdown
  lintMarkdown: (markdown: string) => { errors: any[], fixes: string };
  
  // Generate markdown from structured data
  generateMarkdown: (data: any, template: string) => string;
}

// AI-powered markdown shortcuts
const markdownAIShortcuts = {
  'ai-table': 'Generate table from selected data',
  'ai-code': 'Format and document code block',
  'ai-docs': 'Generate documentation',
  'ai-lint': 'Lint and fix markdown',
  'ai-convert': 'Convert between formats'
};
```

### Custom Toolbar for Markdown
```typescript
// Markdown-specific toolbar components
interface MarkdownToolbarButton {
  id: string;
  icon: React.ReactNode;
  title: string;
  markdown: string; // Markdown to insert
  cursorPosition?: number; // Where to place cursor after insert
  aiEnhanced?: boolean;
}

const markdownToolbarButtons: MarkdownToolbarButton[] = [
  {
    id: 'header-1',
    icon: <H1Icon />,
    title: 'Header 1',
    markdown: '# ',
    cursorPosition: 2
  },
  {
    id: 'code-block',
    icon: <CodeIcon />,
    title: 'Code Block',
    markdown: '```

```',
    cursorPosition: 4
  },
  {
    id: 'ai-table-generate',
    icon: <TableIcon />,
    title: 'AI Generate Table',
    markdown: '',
    aiEnhanced: true
  },
  {
    id: 'ai-docs-generate',
    icon: <DocsIcon />,
    title: 'AI Generate Docs',
    markdown: '',
    aiEnhanced: true
  }
];
```

### Files to Create/Modify
- src/components/editor/MarkdownEditor.tsx (new Cherry Markdown wrapper)
- src/components/editor/MarkdownToolbar.tsx (markdown-specific toolbar)
- src/components/editor/LivePreview.tsx (live preview component)
- src/components/editor/MarkdownAIIntegration.tsx (AI integration for markdown)
- src/hooks/useCherryMarkdown.ts (Cherry Markdown hook)
- src/hooks/usePreviewSync.ts (preview synchronization hook)
- src/utils/cherryConfig.ts (editor configuration)
- src/utils/markdownOperations.ts (markdown processing utilities)
- src/utils/markdownAIAssistant.ts (AI markdown operations)
- src/types/markdown.ts (TypeScript types for markdown)
- src/styles/markdown.css (markdown-specific styles)
- src/styles/preview.css (preview styling)

### Integration Points
```typescript
// Integration with note store for markdown format
interface Note {
  id: string;
  title: string;
  content: string; // Markdown content
  format: 'markdown';
  previewHtml?: string; // Cached HTML preview
}

// Integration with AI assistant for markdown operations
interface AIAssistantState {
  // ... existing fields
  markdownOperations: MarkdownAIOperations;
  currentMarkdown: string;
  previewMode: 'edit' | 'preview' | 'split';
}
```

### Specialized Markdown Features
```typescript
// Math formula support
const mathSupport = {
  renderFormulas: (html: string) => string,
  validateFormula: (formula: string) => boolean,
  extractFormulas: (markdown: string) => string[]
};

// Diagram support
const diagramSupport = {
  renderMermaid: (code: string) => Promise<string>,
  renderFlowchart: (code: string) => Promise<string>,
  validateDiagram: (code: string, type: 'mermaid' | 'flowchart') => boolean
};

// Table operations
const tableOperations = {
  createTable: (rows: number, cols: number) => string,
  addRow: (tableMarkdown: string, rowIndex: number) => string,
  addColumn: (tableMarkdown: string, colIndex: number) => string,
  sortTable: (tableMarkdown: string, column: number, ascending: boolean) => string
};
```

### Performance Optimization
- Virtualized rendering for large markdown documents
- Debounced preview updates
- Cached HTML preview generation
- Lazy loading of heavy dependencies (MathJax, Mermaid)
- Memory management for diagram rendering

### Accessibility Features
- Keyboard shortcuts for all markdown operations
- Screen reader support for preview content
- ARIA labels for all toolbar buttons
- Focus management between editor and preview
- High contrast theme support

### Testing Requirements
- [ ] Editor renders and functions correctly
- [ ] Live preview works and syncs properly
- [ ] Markdown formatting produces correct output
- [ ] Code block syntax highlighting works
- [ ] Math formulas render correctly
- [ ] Diagrams (Mermaid/Flowchart) render properly
- [ ] Table editing functions work
- [ ] AI integration for markdown works
- [ ] Export functionality works
- [ ] Mobile responsiveness
- [ ] Accessibility features work
- [ ] Performance with large documents

## Notes
The Cherry Markdown integration provides a comprehensive markdown editing experience with advanced features like math formulas, diagrams, and live preview. The AI integration focuses on markdown-specific operations that enhance productivity for technical writing and documentation.
